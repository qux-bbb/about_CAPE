# 虚拟机配置相关

配置win7：  
```r
下载火绒，安装补丁(只要安装补丁就好了，不需要安装火绒)

下载安装python32位
https://www.python.org/ftp/python/3.8.10/python-3.8.10.exe

配置agent.py 路径: /opt/CAPEv2/agent/agent.py  
https://capev2.readthedocs.io/en/latest/installation/guest/agent.html#installing-the-agent  

安装python依赖
pip3 install pillow pywintrace

下载安装.net4.0
https://www.microsoft.com/en-US/Download/confirmation.aspx?id=17718

关闭防火墙

可能有用的禁止win7一些默认行为和office保护的脚本
https://github.com/doomedraven/Tools/blob/master/Windows/disable_win7noise.bat
```

命令行克隆虚机的原始方法：  
https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/virtualization_deployment_and_administration_guide/cloning-a-vm  


查看、绑定、删除绑定机器与hostonly网络的ip关系: ./machine_hostonly_net_ip.py  


## 克隆虚机
复制虚机前注意先恢复原虚机的快照、设置自动获取ip之后，关机(Shut Down)再操作  

使用脚本: /opt/CAPEv2/utils/clone-machines.py  
最好复制到一个单独的地方使用，需要安装依赖：  
```r
randmac
tqdm
```

需要修改脚本头部的几个变量：  
```r
NETWORK_NAME = "hostonly"  # 目标虚机要用的网络
DEFAULT_STORAGE = "/opt/VMs"  # 目标虚机存储的位置
SLEEP_TIME = 650  # 虚机开机后等待的时间（建议设短一些，等待时间之后才会创建快照）
DEFAULT_SNAPSHOT_NAME = "snapshot_new"  # 要创建的快照名称，和原虚机的快照没有关系
```

复制3个虚机的命令：  
```r
sudo ./venv/bin/python clone-machines.py --original win7 --original-disk /opt/VMs/win7.qcow2 --prefix win7 --count 3 --count-offset 2 --ip 192.168.100.132
```

待解决问题  
- [ ] 克隆的虚机无法联网
- [ ] Win7过一段时间复制虚机开机会弹出激活窗口，影响创建快照
