# 虚拟机配置相关

查看、绑定、删除绑定机器在hostonly网络的ip: ./machine_hostonly_net_ip.py  

配置win7：  
```r
下载火绒，安装补丁(只要安装补丁就好了，不需要安装火绒)

下载安装python32位
https://www.python.org/ftp/python/3.8.10/python-3.8.10.exe

配置agent.py
https://capev2.readthedocs.io/en/latest/installation/guest/agent.html#installing-the-agent  
路径: /opt/CAPEv2/agent/agent.py
将agent.py改名为 agent.pyw, 放入该文件夹: `C:\ProgramData\Microsoft\Windows\Start Menu\Programs\StartUp`

安装python依赖
pip3 install pillow pywintrace

下载安装.net4.0
https://www.microsoft.com/en-US/Download/confirmation.aspx?id=17718

关闭防火墙

禁止开机激活弹窗提示(新虚机建立快照可能遇到)，手动或使用以下命令禁用sppsvc服务
sc stop sppsvc
sc config sppsvc start= disabled

禁止win7一些默认行为和office保护的脚本
https://github.com/doomedraven/Tools/blob/master/Windows/disable_win7noise.bat

virt-manager中创建hostonly网络，模式为"Isolated"，将虚机网络切换为hostonly

使用machine_hostonly_net_ip.py绑定虚机在hostonly网络的ip：
usage:   python3 ./machine_hostonly_net_ip.py set <machine_name> <ip>
exmaple: python3 ./machine_hostonly_net_ip.py set win7 192.168.100.131

虚机中设置ipv4网络为"自动获得IP地址"，在"高级"设置中添加默认网关，如: 192.168.100.1

重启虚机，命令行确认虚机ip为绑定的ip，任务管理器确认有pythonw.exe进程

创建快照
```

在 `/opt/CAPEv2/conf/kvm.conf` 配置文件中设置虚机相应信息，注意 machines 和 interface 设置正确的值，示例如下(tags和arch不重要)：  
```r
[win7-1]
label = win7-1
platform = windows
ip = 192.168.100.132                                                            
tags = x64 
snapshot = snapshot_new
arch = x64
```
重启 cape 和 cape-web 服务  


命令行克隆虚机的原始方法：  
https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/virtualization_deployment_and_administration_guide/cloning-a-vm  


## 克隆虚机
虽然kvm-qemu.sh里有Clone功能，但只是简单的复制一个虚机，费时间、占空间，没有设置ip、建立快照的功能，没有clone-machines.py方便  

复制虚机前注意先恢复原虚机的快照，关机(Shut Down)再操作  

使用脚本: /opt/CAPEv2/utils/clone-machines.py  
最好复制到一个单独的地方使用，需要安装依赖：  
```r
randmac
tqdm
```

需要修改脚本头部的几个变量：  
```r
NETWORK_NAME = "hostonly"  # 目标虚机要用的网络
DEFAULT_STORAGE = "/opt/VMs"  # 目标虚机存储的位置
SLEEP_TIME = 650  # 虚机开机后等待的时间（建议设短一些，等待时间之后才会创建快照）
DEFAULT_SNAPSHOT_NAME = "snapshot_new"  # 要创建的快照名称，和原虚机的快照没有关系
```

复制3个虚机的命令：  
```r
sudo ./venv/bin/python clone-machines.py --original win7 --original-disk /opt/VMs/win7.qcow2 --prefix win7 --count 3 --count-offset 2 --ip 192.168.100.132
```

复制之后需要在 `/opt/CAPEv2/conf/kvm.conf` 配置文件中设置虚机相应信息，注意在 machines 行增加虚机名  
重启 cape 和 cape-web 服务  


待解决问题  
- [ ] 额外的两个特殊DNS解析: isatap.hostonly wpad.hostonly
- [ ] Win7过一段时间复制虚机开机会弹出激活窗口，影响创建快照


## 虚机网络问题排查
```r
1. 允许流量转发
查看: /proc/sys/net/ipv4/ip_forward, 值应该为1
2. 上网网卡
查看: /opt/CAPEv2/conf/routing.conf, `route = internet` 且 internet 变量应该设置为上网的网卡名称
3. hostonly网卡
查看: /opt/CAPEv2/conf/kvm.conf, interface 应该设置为 hostonly 对应的网卡名称
4. 虚机内默认路由
如果虚机内网络设置为"自动获取IP地址"，需要注意在"高级"中添加默认路由
```
